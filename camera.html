<script>
  const video = document.getElementById('video');
  const img = document.getElementById('capturedImage');
  const photoCapturedMessage = document.getElementById('photoCapturedMessage');
  const nextStepButton = document.getElementById('next-step');
  const retakeButton = document.getElementById('retake');
  let stream;
  let canvas = document.createElement('canvas');
  let capturedImage = null;

  // Start the camera
  async function startCamera() {
    try {
      stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: 'environment' } // Use back camera
      });
      video.srcObject = stream;
    } catch (error) {
      console.error("Error accessing the camera: ", error);
    }
  }

  // Capture button handler
  document.getElementById('capture').addEventListener('click', function() {
    const track = stream.getVideoTracks()[0];
    if (track.getCapabilities().torch) {
      track.applyConstraints({ advanced: [{ torch: true }] }); // Turn on flash before capture
    }

    setTimeout(function() {
      // Capture the frame
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      canvas.getContext('2d').drawImage(video, 0, 0);
      capturedImage = canvas.toDataURL('image/png'); // Save captured image as data URL

      // Replace the video feed with the captured image
      img.src = capturedImage;
      img.style.display = 'block'; // Show the captured image
      video.style.display = 'none'; // Hide the video feed
      photoCapturedMessage.style.display = 'block'; // Show the "photo captured" message
      nextStepButton.style.display = 'inline-block'; // Show the next button
      retakeButton.style.display = 'inline-block'; // Show the "Retake" button

      // Turn off the flash after capture
      if (track.getCapabilities().torch) {
        setTimeout(() => track.applyConstraints({ advanced: [{ torch: false }] }), 500);
      }
    }, 500); // Adding a slight delay to synchronize the capture
  });

  // Retake button handler
  document.getElementById('retake').addEventListener('click', function() {
    img.style.display = 'none'; // Hide the captured image
    video.style.display = 'block'; // Show the video feed again
    photoCapturedMessage.style.display = 'none'; // Hide the capture message
    nextStepButton.style.display = 'none'; // Hide the next button
    retakeButton.style.display = 'none'; // Hide the retake button
    startCamera(); // Restart the camera
  });

  // Proceed to customer information step
  document.getElementById('next-step').addEventListener('click', function() {
    document.getElementById('confirmationImage').src = capturedImage; // Pass the captured image to the next step
    showStep('step-2');
  });

  // Back to capture step
  document.getElementById('back-step').addEventListener('click', function() {
    showStep('step-1');
    img.style.display = 'none'; // Hide the image when going back
    video.style.display = 'block'; // Show the video feed again
    startCamera(); // Restart the camera
  });

  // Confirm and submit handler
  document.getElementById('confirm-submit').addEventListener('click', function() {
    alert("Customer information confirmed and submitted!");
    // Add your submission logic here (e.g., send the capturedImage and customer info to a server)
  });

  // Helper to switch steps
  function showStep(step) {
    document.querySelectorAll('.step').forEach(s => s.classList.remove('step-active'));
    document.getElementById(step).classList.add('step-active');
  }

  // Start the camera on page load
  startCamera();
</script>